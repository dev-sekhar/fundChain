<!DOCTYPE html>
<html>
<head>
    <title>Requirements Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Arimo', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #0F0D46;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .header {
            text-align: center;
            padding: 20px;
        }
        .bubble {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            vertical-align: middle;
        }
        .status-bubble {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-text {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
    <script>
        function getTomorrowDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().split('T')[0];
        }

        function isValidTargetDate(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(date);
            return targetDate >= today;
        }

        function isValidActualDate(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const actualDate = new Date(date);
            return actualDate <= today && actualDate >= today;
        }

        async function loadRequirements() {
            const response = await fetch('req-arch-comp.json');
            const data = await response.json();
            const tableBody = document.getElementById('requirementsTableBody');

            document.getElementById('projectName').textContent = `${data.projectName}: Requirements Tracker`;

            const tomorrow = getTomorrowDate();

            data.steps.forEach((group, groupIndex) => {
                group.requirements.forEach((req, reqIndex) => {
                    const functionalRequirement = req.functionalRequirement || req;
                    const details = req.details ? req.details.join(', ') : '';
                    const componentCount = req.components ? req.components.length : 0;

                    if (componentCount > 0) {
                        const mainRow = document.createElement('tr');
                        mainRow.innerHTML = `
                            <td rowspan="${componentCount}" class="requirement">${groupIndex + 1}.${reqIndex + 1}</td>
                            <td rowspan="${componentCount}" class="requirement">${functionalRequirement}</td>
                            <td rowspan="${componentCount}" class="requirement">${details}</td>
                            <td rowspan="${componentCount}" class="architecture-layer">${group.title}</td>
                            <td>${req.components[0]}</td>
                            <td><input type="checkbox" class="coding" data-component="${req.components[0]}" /></td>
                            <td><input type="checkbox" class="testing" data-component="${req.components[0]}" disabled /></td>
                            <td><input type="checkbox" class="deployment" data-component="${req.components[0]}" disabled /></td>
                            <td><span class="bubble"></span></td>
                            <td><span class="status-bubble"></span><span class="status-text">Pending</span></td>
                            <td><input type="date" class="target-date" value="${tomorrow}" min="${tomorrow}" /></td>
                            <td><input type="date" class="actual-date" value="" max="${new Date().toISOString().split('T')[0]}" /></td>
                        `;
                        tableBody.appendChild(mainRow);

                        addEventListeners(mainRow, req.components[0]);

                        req.components.slice(1).forEach(component => {
                            const componentRow = document.createElement('tr');
                            componentRow.innerHTML = `
                                <td>${component}</td>
                                <td><input type="checkbox" class="coding" data-component="${component}" /></td>
                                <td><input type="checkbox" class="testing" data-component="${component}" disabled /></td>
                                <td><input type="checkbox" class="deployment" data-component="${component}" disabled /></td>
                                <td><span class="bubble"></span></td>
                                <td><span class="status-bubble"></span><span class="status-text">Pending</span></td>
                                <td><input type="date" class="target-date" value="${tomorrow}" min="${tomorrow}" /></td>
                                <td><input type="date" class="actual-date" value="" max="${new Date().toISOString().split('T')[0]}" /></td>
                            `;
                            tableBody.appendChild(componentRow);

                            addEventListeners(componentRow, component);
                        });
                    }
                });
            });

            loadComponentStates();
        }

        function addEventListeners(row, component) {
            const codingCheckbox = row.querySelector('.coding');
            const testingCheckbox = row.querySelector('.testing');
            const deploymentCheckbox = row.querySelector('.deployment');

            // Add event listener for coding checkbox
            codingCheckbox.addEventListener('change', () => {
                testingCheckbox.disabled = !codingCheckbox.checked;
                if (!codingCheckbox.checked) {
                    testingCheckbox.checked = false;
                    deploymentCheckbox.checked = false;
                    deploymentCheckbox.disabled = true;
                }
                updateStatus(row);
                saveComponentState(component);
            });

            // Add event listener for testing checkbox
            testingCheckbox.addEventListener('change', () => {
                deploymentCheckbox.disabled = !testingCheckbox.checked;
                if (!testingCheckbox.checked) {
                    deploymentCheckbox.checked = false;
                }
                updateStatus(row);
                saveComponentState(component);
            });

            // Add event listener for deployment checkbox
            deploymentCheckbox.addEventListener('change', () => {
                updateStatus(row);
                saveComponentState(component);
            });

            // Initialize status
            updateStatus(row);

            // Date listeners remain the same
            const targetDateInput = row.querySelector('.target-date');
            const actualDateInput = row.querySelector('.actual-date');

            if (targetDateInput) {
                targetDateInput.addEventListener('change', (e) => {
                    if (!isValidTargetDate(e.target.value)) {
                        e.target.value = getTomorrowDate();
                    }
                    saveComponentState(component);
                });
            }

            if (actualDateInput) {
                actualDateInput.addEventListener('change', (e) => {
                    const today = new Date().toISOString().split('T')[0];
                    if (e.target.value && !isValidActualDate(e.target.value)) {
                        e.target.value = today;
                    }
                    saveComponentState(component);
                });
            }
        }

        function updateStatus(row) {
            const codingCheckbox = row.querySelector('.coding');
            const testingCheckbox = row.querySelector('.testing');
            const deploymentCheckbox = row.querySelector('.deployment');
            const statusText = row.querySelector('.status-text');
            const statusBubble = row.querySelector('.status-bubble');

            let status = 'Pending';
            let bubbleColor = '#646262';

            if (codingCheckbox.checked || testingCheckbox.checked || deploymentCheckbox.checked) {
                status = 'In-Progress';
                bubbleColor = '#FE9900';
            }

            if (codingCheckbox.checked && testingCheckbox.checked && deploymentCheckbox.checked) {
                status = 'Completed';
                bubbleColor = '#4DFF07';
            }

            statusText.textContent = status;
            statusBubble.style.backgroundColor = bubbleColor;
        }

        function saveComponentState(component) {
            const checkbox = document.querySelector(`input[type="checkbox"][data-component="${component}"]`);
            if (!checkbox) return;

            const row = checkbox.closest('tr');
            if (!row) return;

            const coding = row.querySelector('.coding').checked;
            const testing = row.querySelector('.testing').checked;
            const deployment = row.querySelector('.deployment').checked;
            const status = row.querySelector('.status-text').textContent;
            const targetDate = row.querySelector('.target-date').value;
            const actualDate = row.querySelector('.actual-date').value;

            const state = {
                coding,
                testing,
                deployment,
                status,
                targetDate,
                actualDate
            };

            localStorage.setItem(component, JSON.stringify(state));
        }

        function loadComponentStates() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-component]');
            const processedComponents = new Set();

            checkboxes.forEach(checkbox => {
                const component = checkbox.getAttribute('data-component');
                
                if (!processedComponents.has(component)) {
                    processedComponents.add(component);
                    
                    const state = JSON.parse(localStorage.getItem(component));

                    if (state) {
                        const row = checkbox.closest('tr');
                        const codingCheckbox = row.querySelector('.coding');
                        const testingCheckbox = row.querySelector('.testing');
                        const deploymentCheckbox = row.querySelector('.deployment');
                        const statusDropdown = row.querySelector('.status-dropdown');
                        const targetDateInput = row.querySelector('.target-date');
                        const actualDateInput = row.querySelector('.actual-date');

                        // Load checkbox states in the correct order
                        if (codingCheckbox) {
                            codingCheckbox.checked = state.coding;
                        }
                        
                        if (testingCheckbox) {
                            testingCheckbox.disabled = !codingCheckbox.checked;
                            testingCheckbox.checked = state.testing;
                        }
                        
                        if (deploymentCheckbox) {
                            deploymentCheckbox.disabled = !testingCheckbox.checked;
                            deploymentCheckbox.checked = state.deployment;
                        }

                        // Load other states
                        if (statusDropdown && state.status) statusDropdown.value = state.status;
                        
                        if (targetDateInput && state.targetDate) {
                            targetDateInput.value = isValidTargetDate(state.targetDate) 
                                ? state.targetDate 
                                : getTomorrowDate();
                        }
                        
                        if (actualDateInput && state.actualDate) {
                            actualDateInput.value = isValidActualDate(state.actualDate)
                                ? state.actualDate
                                : new Date().toISOString().split('T')[0];
                        }
                    } else {
                        // Initialize new components with correct disabled states
                        const row = checkbox.closest('tr');
                        const testingCheckbox = row.querySelector('.testing');
                        const deploymentCheckbox = row.querySelector('.deployment');
                        
                        testingCheckbox.disabled = true;
                        deploymentCheckbox.disabled = true;
                    }
                }
            });
        }

        window.onload = loadRequirements;
    </script>
</head>
<body>
    <div class="header">
        <h1 id="projectName">Requirements Tracker</h1>
    </div>
    <table>
        <tr>
            <th>ID</th>
            <th>Functional Requirement</th>
            <th>Details</th>
            <th>Architecture Layer</th>
            <th>Component</th>
            <th>Coding</th>
            <th>Testing</th>
            <th>Deployment</th>
            <th>Completion</th>
            <th>Status</th>
            <th>Target Date</th>
            <th>Actual Date</th>
        </tr>
        <tbody id="requirementsTableBody"></tbody>
    </table>
</body>
</html>